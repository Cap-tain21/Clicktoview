name: Build Clicktoview APK

on:
  workflow_dispatch:
  push:
    paths:
      - 'template/myapp/app/src/main/assets/webcontent/**'
      - 'template/myapp/**'
      - '.github/workflows/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Android command-line tools and SDK components
        run: |
          set -e
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT
          curl -fsSL https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip -o cmdline-tools.zip
          unzip -q cmdline-tools.zip -d cmdline-tools
          rm cmdline-tools.zip
          mv cmdline-tools/cmdline-tools cmdline-tools/latest
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-34" "build-tools;34.0.0"
        shell: bash

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: '9.0'

      - name: Build Debug APK
        working-directory: template/myapp
        run: |
          set -e
          export ANDROID_SDK_ROOT=${{ env.ANDROID_SDK_ROOT }}
          export PATH=$ANDROID_SDK_ROOT/platform-tools:$PATH
          gradle :app:assembleDebug --no-daemon

      - name: Collect APK
        run: |
          mkdir -p deploy
          cp template/myapp/app/build/outputs/apk/debug/app-debug.apk deploy/Clicktoview.apk
          ls -l deploy/Clicktoview.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: Clicktoview
          path: deploy/Clicktoview.apk
